---
# Validate platform compatibility

- name: Validate supported operating system
  assert:
    that:
      - ansible_distribution == "Ubuntu"
      - ansible_distribution_major_version | int >= 20
    fail_msg: >
      Unsupported OS detected.
      This role supports Ubuntu 20.04+ only.
    success_msg: >
      Supported OS detected.

- name: Fetch Java version
  ansible.builtin.shell: |
    java -version 2>&1 | awk -F'"' 'NR==1{ print $2 }' | awk -F. '{ print $1 }'
  register: java_version_output
  failed_when: java_version_output.rc != 0

- name: Set java_major_version fact if command succeeded
  ansible.builtin.set_fact:
    java_major_version: "{{ java_version_output.stdout | default('0') }}"
  when: java_version_output.rc == 0

- name: Assert that Java version is 17 or higher
  ansible.builtin.assert:
    that:
      - "java_major_version is defined"
      - "java_major_version | int >= 17"
    fail_msg: "Java version {{ java_major_version | default('not found') }} is installed, but version 17 or higher is required."
    success_msg: "Java version {{ java_major_version }} meets the requirement of 17 or higher."
  when: java_major_version is defined

# Install base dependencies
- name: Install base packages
  apt:
    name:
      - curl
      - tar
      - python3-psycopg2
      - acl
    update_cache: yes
