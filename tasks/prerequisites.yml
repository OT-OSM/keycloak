---
# Validate platform compatibility

- name: Validate supported operating system
  assert:
    that:
      - ansible_distribution == "Ubuntu"
      - ansible_distribution_major_version | int >= 20
    fail_msg: >
      Unsupported OS detected.
      This role supports Ubuntu 20.04+ only.
    success_msg: >
      Supported OS detected.

- name: Check Java runtime availability
  ansible.builtin.command: java --version
  register: java_check
  changed_when: false
  failed_when: java_check.rc != 0

- name: Validate Java major version (runtime)
  ansible.builtin.assert:
    that:
      - java_check.stdout is search("openjdk 17|openjdk 18|openjdk 19|openjdk 20|openjdk 21")
    fail_msg: >
      Installed Java version is not supported.
      Keycloak requires Java 17 or newer.

# Install base dependencies
- name: Install base packages
  apt:
    name:
      - curl
      - tar
      - python3-psycopg2
      - acl
    update_cache: yes
