---
# =========================================================
# Azure Entra ID OIDC Identity Provider (DEFAULT LOGIN)
# Alias = oidc  â†’ Redirect: /broker/oidc/endpoint
# =========================================================

- name: Get existing Identity Providers
  ansible.builtin.command: >
    {{ keycloak_install_dir }}/bin/kcadm.sh get identity-provider/instances -r master
  register: idp_list
  become_user: "{{ keycloak_user }}"

- name: Check if OIDC IdP exists
  ansible.builtin.set_fact:
    oidc_idp_exists: >-
      {{ (idp_list.stdout | from_json
          | selectattr('alias', 'equalto', 'oidc')
          | list
          | length) > 0 }}

- name: Create Azure Entra ID OIDC Identity Provider (default)
  ansible.builtin.command: >
    {{ keycloak_install_dir }}/bin/kcadm.sh create identity-provider/instances
    -r master
    -s alias=oidc
    -s providerId=oidc
    -s enabled=true
    -s displayName="Login with Azure"
    -s authenticateByDefault=true
    -s hideOnLogin=false
    -s trustEmail=true
    -s firstBrokerLoginFlowAlias="first broker login"
    -s config.discoveryUrl="https://login.microsoftonline.com/{{ item.tenant_id }}/v2.0/.well-known/openid-configuration"
    -s config.clientId="{{ item.client_id }}"
    -s config.clientSecret="{{ item.client_secret }}"
    -s config.defaultScope="openid profile email"
  loop: "{{ keycloak_oidc_providers }}"
  become_user: "{{ keycloak_user }}"
  when: not oidc_idp_exists

- name: Refresh Identity Providers list
  ansible.builtin.command: >
    {{ keycloak_install_dir }}/bin/kcadm.sh get identity-provider/instances -r master
  register: idp_list_after
  become_user: "{{ keycloak_user }}"

- name: Extract OIDC IdP internalId
  ansible.builtin.set_fact:
    oidc_idp_internal_id: >-
      {{ (idp_list_after.stdout | from_json
          | selectattr('alias', 'equalto', 'oidc')
          | list
          | first).internalId }}

- name: Ensure OIDC IdP is default login
  ansible.builtin.command: >
    {{ keycloak_install_dir }}/bin/kcadm.sh update identity-provider/instances/{{ oidc_idp_internal_id }}
    -r master
    -s enabled=true
    -s hideOnLogin=true
    -s authenticateByDefault=true
    -s trustEmail=true
    -s firstBrokerLoginFlowAlias="first broker login"
    -s config.guiOrder=1
  become_user: "{{ keycloak_user }}"
