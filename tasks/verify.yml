---
# -------------------------------------------------------------------
# Verify Keycloak service is running
# -------------------------------------------------------------------
- name: Verify Keycloak service is active
  ansible.builtin.command: systemctl is-active keycloak
  register: keycloak_status
  changed_when: false
  failed_when: keycloak_status.stdout not in ["active", "activating"]

# -------------------------------------------------------------------
# Informational: HTTPS configuration status
# (No port waiting to avoid runtime TLS dependency)
# -------------------------------------------------------------------
- name: Show HTTPS configuration status
  ansible.builtin.debug:
    msg: >
      Keycloak HTTPS is {{
        'ENABLED' if (keycloak_https_enabled | default(false) | bool)
        else 'DISABLED'
      }}.
      Runtime TLS binding depends on certificate validation.

# -------------------------------------------------------------------
# Observability Configuration
# -------------------------------------------------------------------

- name: Validate observability configuration
  ansible.builtin.assert:
    that:
      - keycloak_log_format in ['plain', 'json']
    fail_msg: "Invalid log format. Supported: plain | json"
  when: keycloak_observability_enabled | bool

- name: Wait for Keycloak to be ready
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ keycloak_http_port }}"
    delay: 5
    timeout: 120

