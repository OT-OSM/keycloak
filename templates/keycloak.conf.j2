# =========================================================
# DATABASE
# =========================================================
db=postgres
db-url=jdbc:postgresql://{{ keycloak_db_host }}:{{ keycloak_db_port }}/{{ keycloak_db_name }}
db-username={{ keycloak_db_user }}

# =========================================================
# HTTP / HTTPS
# =========================================================
{% if keycloak_https_enabled | bool %}

# --- HTTPS ENABLED ---
http-enabled=false
https-host={{ keycloak_https_host | default('0.0.0.0') }}
https-port={{ keycloak_https_port }}
https-certificate-file={{ keycloak_tls_cert_file }}
https-certificate-key-file={{ keycloak_tls_key_file }}

{% else %}

# --- HTTP ENABLED ---
http-enabled=true
http-host=0.0.0.0
http-port={{ keycloak_http_port }}

{% endif %}


# =========================================================
# HOSTNAME (CRITICAL FOR SSO / REDIRECTS)
# =========================================================
hostname={{ keycloak_public_hostname }}
hostname-url=https://{{ keycloak_public_hostname }}
hostname-strict={{ keycloak_hostname_strict | lower }}
hostname-strict-https={{ keycloak_hostname_strict_https | lower }}

# =========================================================
# PROXY (NGINX / LB)
# =========================================================
proxy={{ keycloak_proxy_mode }}
proxy-headers=xforwarded

# =========================================================
# OBSERVABILITY
# =========================================================
{% if keycloak_observability_enabled | bool %}
http-management-enabled=true
http-management-host=0.0.0.0
http-management-port={{ keycloak_management_port }}

{% if keycloak_metrics_enabled | bool %}
metrics-enabled=true
{% endif %}

{% if keycloak_health_enabled | bool %}
health-enabled=true
{% endif %}

log-level={{ keycloak_log_level }}

{% if keycloak_log_format == "json" %}
log-console-output=json
{% endif %}
{% endif %}


# =========================================================
# CLUSTER / HA
# =========================================================
{% if keycloak_ha_enabled | bool %}

cache=ispn
cache-stack={{ keycloak_cache_stack | default('tcp') }}

cluster={{ keycloak_cluster_name }}
node-name={{ keycloak_node_name }}

cache-owner-count=2
cache-owner-count-auth-sessions=2

jgroups.discovery.protocol=JDBC_PING
jgroups.jdbc_ping.datasource=default

{% endif %}
